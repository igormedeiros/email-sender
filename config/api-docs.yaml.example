openapi: 3.0.0
info:
  title: Email Sender API
  version: 1.0.0
  description: API para gerenciamento de envios de email e configurações
  contact:
    email: suporte@seu-dominio.com
servers:
  - url: http://localhost:5000
    description: Servidor de desenvolvimento
paths:
  /api/health:
    get:
      summary: Verifica o status da API
      description: Endpoint para monitoramento e healthcheck
      responses:
        '200':
          description: API em funcionamento
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"
                  timestamp:
                    type: string
                    format: date-time
                    example: "2023-03-15T14:30:00Z"
  
  /api/emails/send:
    post:
      summary: Envia emails em lote
      description: Processa e envia emails usando um arquivo CSV e template HTML
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendEmailRequest'
      responses:
        '200':
          description: Emails enviados com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SendEmailResponse'
        '400':
          description: Parâmetros inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /api/emails/test-smtp:
    post:
      summary: Testa a conexão SMTP
      description: Envia um email de teste para verificar a configuração SMTP
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TestSmtpRequest'
      responses:
        '200':
          description: Email de teste enviado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Parâmetros inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /api/emails/clear-flags:
    post:
      summary: Limpa flags de envio
      description: Remove as marcações de emails já enviados para permitir reenvio
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClearFlagsRequest'
      responses:
        '200':
          description: Flags limpas com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClearFlagsResponse'
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /api/emails/sync-unsubscribed:
    post:
      summary: Sincroniza emails descadastrados
      description: Atualiza a lista principal com os emails descadastrados
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SyncUnsubscribedRequest'
      responses:
        '200':
          description: Sincronização concluída com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncUnsubscribedResponse'
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /api/config:
    get:
      summary: Obtém as configurações atuais
      description: Retorna o conteúdo do arquivo email.yaml
      responses:
        '200':
          description: Configurações retornadas com sucesso
          content:
            application/json:
              schema:
                type: object
        '404':
          description: Arquivo de configuração não encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    
    put:
      summary: Atualiza todas as configurações
      description: Substitui completamente o arquivo email.yaml
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Configurações atualizadas com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigUpdateResponse'
        '400':
          description: Configurações inválidas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /api/config/partial:
    patch:
      summary: Atualiza parcialmente as configurações
      description: Atualiza apenas os campos especificados no email.yaml
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Configurações atualizadas parcialmente com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigUpdateResponse'
        '400':
          description: Configurações inválidas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    SendEmailRequest:
      type: object
      properties:
        csv_file:
          type: string
          description: Caminho para o arquivo CSV
          example: "data/emails.csv"
        template:
          type: string
          description: Nome do template HTML a ser usado
          example: "templates/email.html"
        skip_unsubscribed_sync:
          type: boolean
          description: Se deve pular a sincronização de descadastros
          default: false
        mode:
          type: string
          enum: [test, production]
          description: Modo de envio (test ou production)
      required:
        - template
        - mode
    
    SendEmailResponse:
      type: object
      properties:
        status:
          type: string
          example: "success"
        message:
          type: string
          example: "Emails enviados com sucesso"
        report:
          type: object
          properties:
            report_file:
              type: string
              example: "email_report_20230315_143000.txt"
            total_sent:
              type: integer
              example: 100
            successful:
              type: integer
              example: 95
            failed:
              type: integer
              example: 5
    
    TestSmtpRequest:
      type: object
      properties:
        recipient:
          type: string
          description: Email do destinatário para teste
          example: "test@example.com"
    
    ClearFlagsRequest:
      type: object
      properties:
        csv_file:
          type: string
          description: Caminho para o arquivo CSV
          example: "data/emails.csv"
    
    ClearFlagsResponse:
      type: object
      properties:
        status:
          type: string
          example: "success"
        message:
          type: string
          example: "150 flags limpas com sucesso"
    
    SyncUnsubscribedRequest:
      type: object
      properties:
        csv_file:
          type: string
          description: Caminho para o arquivo CSV principal
          example: "data/emails.csv"
        unsubscribe_file:
          type: string
          description: Caminho para o arquivo de descadastros
          example: "data/descadastros.csv"
    
    SyncUnsubscribedResponse:
      type: object
      properties:
        status:
          type: string
          example: "success"
        message:
          type: string
          example: "50 emails sincronizados"
        csv_file:
          type: string
          example: "data/emails.csv"
        unsubscribe_file:
          type: string
          example: "data/descadastros.csv"
    
    ConfigUpdateResponse:
      type: object
      properties:
        status:
          type: string
          example: "success"
        message:
          type: string
          example: "Configurações atualizadas com sucesso"
        backup_file:
          type: string
          example: "config/email.backup_20230315_143000.yaml"
    
    SuccessResponse:
      type: object
      properties:
        status:
          type: string
          example: "success"
        message:
          type: string
          example: "Operação realizada com sucesso"
    
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          example: "Mensagem de erro detalhada" 